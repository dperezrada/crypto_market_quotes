---
- hosts: "{{hosts}}"
  vars:
  - repo: git@github.com:dperezrada/crypto_market_quotes.git
  - repo_name: crypto_market_quotes
  - environment_path: /home/deploy/envs/pydev
  - home_path: /home/deploy
  - repos_root: /home/deploy/repos
  - project_branch: master
  - requirements_file: "{{repos_root}}/{{repo_name}}/requirements.txt"


  tasks:
  - name: Pull sources from the repository.
    git: repo={{ repo }} dest={{ repos_root }}/{{repo_name}} version={{ project_branch|default("master") }} accept_hostkey=yes

  - name: Change owner to deploy
    file: path={{ repos_root }}/{{repo_name}} owner=deploy group=deploy recurse=yes

  - name: Install requirements
    shell: "{{environment_path}}/bin/pip install -r {{requirements_file}}"

  - name: Install package
    shell: "cd {{ repos_root }}/{{repo_name}};{{environment_path}}/bin/python setup.py develop"

  - name: Setting crontab for each exchange
    cron: name="calculate exchange {{ item.exchange }}" hour="*" minute="{{ item.minute }}" user="deploy" job="mkdir -p /home/deploy/data/{{ item.exchange }}/$(date +\\%Y-\\%m-\\%d); /home/deploy/envs/pydev/bin/python3.6 /home/deploy/repos/crypto_market_quotes/crypto_market_quotes/main.py {{ item.exchange }} >> /home/deploy/data/{{ item.exchange }}/$(date +\\%Y-\\%m-\\%d)/$(date +\\%H).log 2>> {{ home_path }}/logs/calculate_{{ item.exchange }}.log"
    with_items:
      - { minute: '*', exchange: 'bitfinex' }
      - { minute: '*', exchange: 'surbtc' }
      - { minute: '*', exchange: 'kraken' }
      - { minute: '*', exchange: 'cryptomkt' }
